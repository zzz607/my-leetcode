# 768. 最多能完成排序的块II  

[力扣题目链接](https://leetcode-cn.com/problems/max-chunks-to-make-sorted-ii/)  

这个问题和“最多能完成排序的块”相似，但给定数组中的元素可以重复，输入数组最大长度为2000，
其中的元素 最大为10**8。

arr是一个可能包含重复元素的整数数组，我们将这个数组分割成几个“块”，并将这些块分别进行排序。
之后再 连接起来，使得连接的结果和按升序排序后的原数组相同。

我们最多能将数组分成多少块？

示例1:
```
输入: arr = [5,4,3,2,1]
输出: 1
解释:将数组分成2块或者更多块，都无法得到所需的结果。
例如，分成 [5, 4], [3, 2, 1] 的结果是 [4, 5, 1, 2, 3]，这不是有序的数组。
```

示例 2:
```
输入: arr = [2,1,3,4,4]
输出: 4
解释:我们可以把它分成两块，例如 [2, 1], [3, 4, 4]。
然而，分成 [2, 1], [3], [4], [4] 可以得到最多的块数。
```

注意:
- arr的长度在[1, 2000]之间。
- arr[i]的大小在[0, 10**8]之间

## 思路
局部排序后的结果与整体排序后的结果一致，需要满足的条件的：**每个被切割的块中的最大值，
都要比后面的块的最小值要小**  

### 方法一
利用上面那个朴素的思路，可以得到这样的一个算法：
1. 设定索引位置为0的值为一个块的起点，记为curMax。对于示例[2,1,3,4,4,1]来讲，此时
   curMax的值为2
2. 往后搜索，直到找到一个比curMax大的元素nextMax，此时将arr[curMax:nextMax]
   这一段的值切分为一个候选块，将将候选块中入栈。只所以说是候选块，因为我们不确定后面还
   有没有比curMax小的元素值了。同时将curMax设定为nextMax。对于示例2来讲，此时栈中
   的数据应该为：[(max:2, min:1)]
3. 重复第2步，直到整个数组遍历完成。 此时，栈中的数据应该为：
   [(max:2, min:1), (max:3, min:3), (max:4, min:4), (max:4, min:1)]  
4. 依次弹出栈中元素，记弹出的元素为curChunk，栈顶元素为top。
   1. 若curChunk.min >= top.max，则curChunk划块成功，总数加1
   2. 否则将top.min = min(top.min, curChunk.min)，然后跳转第1步继续处理

#### 代码

````Go
func maxChunksToSorted2(arr []int) int {
	var count int

	var cache mmSlice
	var min, max = arr[0], arr[0]
	for i := 1; i < len(arr); i++ {
		if arr[i] >= max {
			cache = append(cache, &mm{min, max})
			min, max = arr[i], arr[i]
		} else if arr[i] <= min {
			min = arr[i]
		}
	}
	cache = append(cache, &mm{min, max})

	sort.Sort(cache)
	for idx, item := range cache {
		fmt.Printf("cache[%d]: %v\n", idx, item)
	}

	last := cache[cache.Len() - 1]
	for i := cache.Len() - 2; i >= 0; i-- {
		cur := cache[i]
		if last.min >= cur.max {
			count++
			fmt.Printf("count: %d, index: %d, min-max: %d, %d\n", count, i + 1, last.min, last.max)
		} else {
			if last.min <= cur.min {
				cur.min = last.min
			}
			cur.max = last.max
		}
		last = cur
	}
	count++

	return count
}

type mm struct {
	min int
	max int
}
type mmSlice []*mm

func (p mmSlice) Len() int           { return len(p) }
func (p mmSlice) Less(i, j int) bool { return p[i].max < p[j].max }
func (p mmSlice) Swap(i, j int)      { p[i], p[j] = p[j], p[i] }

````
**复杂度分析**
- 时间复杂度：O(N)
- 空间复杂度：O(N)

<font color="red"><em>注意</em></font>  
很可惜，上面那个实现有个测试用例通不过：  
```
输入: arr = [773,33,1581,888,536,1853,1331,388,242,1506,2276,3676,2824,2491,3385,3039,2854,2925,2246,3900,5582,5395,5709,4449,4933,4371,5671,4816,4694,4609,7881,7208,6207,6935,7869,7005,7367,6357,6371,7853,8474,9787,8816,9422,8698,8081,9607,9283,9209,8065,11593,9998,10722,11367,11808,10010,10117,11659,10510,10206,12637,12429,12209,12814,13496,13879,13383,13840,12958,12647,15073,15136,15150,14310,14771,15978,15467,15087,14732,14607,17890,17287,17567,16937,16561,16624,16604,16855,16011,16839,19775,18838,18558,19651,18645,18309,18148,18170,19526,18767,20145,21952,21722,21335,20827,20232,20918,20100,20352,20872,22674,23649,23140,22295,22463,22203,23817,22892,23481,23937,25665,25515,25242,25107,25327,25186,25379,25454,24447,24287,27643,27005,27696,26820,27533,26313,26825,26885,26848,27121,29785,29405,29828,28499,28994,29863,28430,29235,29348,28849,31801,31717,31637,30426,31265,30059,30099,30558,31418,30574,32930,32963,32639,32896,33548,32483,32377,33198,33271,33541,34516,34182,35762,34785,34674,35790,35842,34640,35842,35874,36869,36022,36567,37556,36662,36929,36702,36140,37429,37170,39233,38288,38847,39163,39425,39517,39423,38425,38640,38405,41624,40793,41926,40875,41634,40358,40575,40352,41901,40948,42684,43864,43805,42066,43330,42610,42093,43499,43685,43853,44528,45177,44746,44581,45054,45701,44652,45902,45707,44005,47245,47594,46978,46137,46795,46713,47191,46231,46720,46272,48168,48515,48137,49031,48893,48353,49488,48060,49775,48848,50274,51468,51352,51384,50769,51276,51922,50695,50963,51118,52369,52645,53407,53761,52582,52593,53056,52225,53700,52343,55164,55782,55157,54908,54197,54379,55742,54701,54076,54881,56327,56911,56710,57221,57193,56282,56442,57300,56304,57020,58107,58189,58205,58889,59022,59224,58277,59276,59262,59190,61402,61862,60534,60906,61412,61117,61544,60989,61231,60907,63428,62302,63582,62911,62819,62634,63624,63847,63554,63728,65362,64025,64704,65904,65343,64895,64695,65441,65139,64426,66937,66899,67389,67337,67791,67196,66461,66496,67601,67730,69300,68499,69491,68347,69605,69019,68571,69443,68111,69784,71907,70291,70247,70981,71573,70422,70712,70132,70052,70467,73058,73097,73676,73385,72965,73069,72873,73041,72404,72470,74839,74238,75723,75182,74367,75320,75303,74935,75693,75507,77592,77816,77187,76271,76593,76369,77672,76672,77442,77102,78241,79652,79037,78027,79890,79470,79468,79519,78680,79321,80548,80792,80316,80145,80413,81023,81062,81781,80909,80277,82235,83180,82037,82769,81998,83946,83124,82856,81967,83319,84782,84204,85501,85953,84281,84086,85542,85741,83996,85519,86135,86881,87624,86730,86720,87240,86304,87289,86189,86805,88189,88309,88827,89136,89733,89391,89073,88710,89731,89213,90360,90439,90983,91670,90106,91601,90038,91522,91433,90743,93256,92464,93361,93033,93062,93889,92257,92576,93775,93474,94453,94251,95208,95196,94580,95100,95393,94815,95169,94039,97135,97200,96486,97522,95984,96454,96891,96387,96999,97617,99904,99853,98335,98783,98612,98990,98863,99323,98565,98626,101238,101478,100332,101012,101081,100160,101144,101396,101869,100303,102967,103491,103341,102569,102362,102727,103144,102838,102947,102984,105253,105588,104823,104604,104321,105334,105128,105493,105000,105096,106798,106973,106336,107169,106033,106348,107466,107615,107450,106856,108299,108571,108378,109876,108061,109172,109195,109880,108174,108782,110075,110676,111881,110499,111279,111709,111052,110781,111277,110638,112582,113196,112607,113099,113004,113868,113820,112967,113861,113261,115384,115016,115440,115799,114269,114781,114851,115013,114284,115222,116761,117294,117429,116602,117914,117024,116885,116625,116958,117871,119729,119578,117969,118332,119065,118776,119644,119355,118766,118994,120970,120624,120214,120276,120832,120903,120429,121536,121061,120811,123623,123256,123412,123031,122623,122045,123724,122407,123165,122118,125014,125202,125895,125088,125625,124008,124516,125771,123970,124736,127231,127849,126739,126236,126393,127868,126802,126853,127863,126212,129228,128099,128560,129382,128740,129815,128605,128001,129230,128874,130754,131066,131698,131723,131933,131661,130037,131699,130449,131011,132585,133908,133192,132586,133757,131958,133173,133831,133098,132650,134046,134037,135122,134204,135773,135915,135464,134458,135118,135854,136219,136180,136099,137255,137426,136300,136919,137641,136154,136032,138723,139605,139740,139223,139840,138877,139695,139151,139542,138731,140210,140401,141869,140379,141655,141271,140916,140069,141213,141404,143355,142654,142879,143761,143920,143919,142636,143543,142003,143256,144995,145684,145394,145482,144156,145871,145212,144077,144348,145503,146327,147074,146144,147786,147836,146289,147677,146839,145936,146001,148622,148709,149083,149437,149661,148163,149059,149718,149136,149477,150209,150009,151610,150600,150597,150518,151204,150369,151443,151876,153683,152583,153105,152772,152896,152236,153417,152169,152960,151973,155649,155911,154802,154797,155666,155090,154896,154632,153971,154355,156965,156494,156487,156408,157877,157156,156881,157430,157634,156008,158120,158059,159161,158055,158254,158744,158047,159674,158750,159150,160220,159936,161636,160493,160217,160523,160960,160127,160300,160168,163853,163563,162259,163358,162128,162910,163205,162930,162076,163456,165552,165325,165043,164313,164846,165010,164942,165433,165602,164047,165921,166685,167821,167664,166861,165993,167662,167807,166971,167810,169878,169497,168116,169657,168583,169456,168375,169162,169884,168602,170534,171469,171296,171852,171090,170850,171811,170201,171671,171112,173380,173255,172150,172803,172559,172994,172822,173235,172124,171992,174665,174917,175346,175017,175470,175337,175379,175562,175332,175663,177670,176473,176029,177889,177771,177024,176378,177017,176558,175971,178776,178004,179582,177921,179808,178233,178358,178213,178341,179625,181593,180516,180482,180377,181645,181667,180820,180076,180699,181510,182841,183231,183880,183228,182604,182106,183684,183515,183753,183834,185173,185715,184107,184538,184296,185810,184570,185229,185824,184983,187825,186049,187273,187651,186375,187846,187779,187175,186528,187331,187909,189244,188797,188927,188303,188764,188295,189875,189785,189492,191732,190873,190261,191120,191618,190948,190281,191793,191480,190912,193760,192647,193263,192276,192842,192725,193835,192393,192003,192809,195349,194363,195324,195283,195397,194859,195015,194840,194180,195774,196178,196255,197308,196445,196764,196207,197167,197698,196901,197619,198522,198735,198593,199424,198347,198957,199489,199083,198013,198124,201611,200463,200289,200085,200587,201071,201872,201542,201476,200083,202572,202214,202493,203119,202260,202766,202707,202889,203436,202968,205463,205385,205379,204281,204058,205361,205192,205858,204221,203906,206279,207341,207606,207255,206522,207383,207250,206344,207227,207213,208084,208477,208720,209510,209190,209323,209657,208122,208384,209353,211446,211009,211342,210441,210681,211731,211582,211399,210438,211838,212641,212653,212104,213683,212340,212375,213362,212122,212232,213890,214421,215697,214020,214798,214460,214683,214172,214392,215494,214003,216491,216271,216838,217055,216900,215940,216975,217004,217346,217318,219792,219813,219079,218248,219650,218549,218470,218046,218117,217973,221888,220026,220659,220173,220588,220658,221723,219970,221177,221507,222919,223819,223151,223747,222057,222154,222809,223594,222883,223234,224641,224634,224338,225791,224699,225496,224561,225408,224678,225877,226297,226451,226052,226483,227499,225888,226863,225984,226138,225887,228393,228571,228084,229390,228878,228617,227915,229410,229584,228919,231356,231411,231071,230054,230194,230892,231215,229901,231032,231599,232472,233858,232873,232788,232391,232308,233508,233697,232078,233770,233938,234813,234298,234972,234909,235472,235089,234760,234150,235233,237193,236938,237549,236882,236260,236003,237410,237870,237117,237707,238125,238607,239003,238929,238419,237927,239062,238694,239396,238400,240864,240540,241734,241396,241125,240550,241163,241272,240215,240550,243838,242995,242883,243091,242556,243349,242924,242699,242903,242304,245870,245594,245456,244244,244950,244148,244848,245564,245686,244490,245987,247272,246994,245964,246565,246175,246930,247176,247600,246480,249068,248773,249028,248732,247897,248447,249060,248538,248642,247877,250276,251829,250630,250556,251304,251348,251686,251386,250898,250304,252154,252104,253674,253712,252713,253230,253221,253449,253714,251968,255101,254453,254856,254640,255155,255860,253898,254878,254224,253972,256808,256552,257012,257784,257122,256820,257727,257109,257584,255925,259767,259459,258888,259024,258708,259617,258008,259558,258824,258042,260694,260383,261029,260797,260035,261656,260962,260186,261173,261333,261875,262101,261902,262279,262660,261981,263685,262899,262575,263525,264691,264902,264436,264862,264630,265351,264735,265846,264697,264524,267124,267703,266549,267178,267012,266013,266586,266026,267023,267289,268527,268643,268020,269769,268440,269530,268829,268944,268192,268480,271308,270987,270821,271020,270271,271386,270693,271702,271656,270294,272635,272795,272928,272244,273157,273335,273067,272591,272880,273331,275234,274057,273908,275330,274771,275625,274325,275536,274333,274797,277177,277227,277505,275899,277174,275921,277712,277373,277532,276421,279072,277980,278484,278106,277910,278616,279781,279093,278945,278767,280924,281826,281141,280019,280428,281680,281611,281551,281085,280105,283478,282071,282431,282350,282294,282914,282464,282971,282404,283759,285032,283958,284680,285787,284942,284429,284335,284113,284014,284471,287667,287292,287032,287287,287737,286744,286459,287631,285870,286221,288292,287960,289058,289780,287861,288976,288811,289549,288335,289673,290367,290468,291038,290931,290507,291703,289865,291445,291497,291539,293307,292827,292082,293611,292663,292665,293765,292025,292889,293661,294600,294421,294274,294393,295770,295177,294693,294043,295776,295828,296837,296734,297752,297683,296822,297769,296604,296923,297639,297594,299209,298525,298600,298485,299525,298353,298915,298155,297894,299481,301273,300047,301044,301796,301399,301589,301431,301749,300501,300000,302871,301941,303772,302448,302633,302492,303348,302795,301906,303480,305293,305452,303933,305540,304124,304393,304264,303945,304762,305018,306040,306571,307390,306099,306505,306582,307519,307458,306140,306344,309103,308593,307943,309268,308032,309257,309489,309725,309223,309141,310891,310662,310797,310437,311350,310443,310526,310361,311059,311208,311863,313010,311891,313711,313677,312693,312529,311995,313467,312186,315253,315253,314133,315127,314137,314119,315113,314784,315640,315571,317317,317095,316066,316459,317052,316105,317571,316933,317412,317141,318358,319154,318414,318724,318079,318245,318040,319835,318939,318921,320628,321034,321061,321362,320875,320048,321717,321174,321508,321504,321857,323700,322741,322661,323329,321886,323612,322565,323819,322865,324266,324753,325810,324133,324581,324947,325162,324474,324592,323911,327346,327376,327768,326395,326088,327827,327093,326782,327303,327306,328669,328764,327943,328526,329215,329248,328230,328668,329507,329540,330663,331185,331128,331618,331288,330044,331399,329883,331218,331646,333214,333601,332027,333431,333815,333453,333036,333362,333058,333445,333999,334597,333851,334436,334129,335489,334042,334212,335025,334244,337349,335868,336506,336063,336603,337235,335886,337027,335857,336386,338376,338265,338539,339772,338486,339235,338633,339188,339549,339670,339853,340289,340212,340680,340703,341290,341034,339882,340703,341531,342530,343470,342349,342270,343183,342018,341970,343240,343545,342358,344112,345337,343969,344819,344482,343923,344193,344541,345593,345355,346469,346825,346368,346122,347707,347814,347704,346267,346007,346345,347959,348798,348105,348824,348287,348319,348801,349176,349823,349174,350068,350528,349936,350354,350584,350185,351164,350391,350882,351405,351868,353018,352458,353481,353441,353694,352967,352350,353658,351856,355278,355547,355182,354640,354522,355386,355604,355173,355661,354471,356689,356185,356561,356574,357811,357528,357118,357641,357061,357311,358435,359020,359232,358368,359199,358478,359378,358232,359107,359128,359857,360397,360105,361130,361236,361521,360762,360976,361263,361089,362019,362050,363178,362759,362234,363802,362373,361884,363172,362280,363931,364050,365387,364170,364269,365684,365264,364996,364241,365148,367210,366883,366203,367242,366786,367680,367543,367698,366294,366621,368646,368442,368064,368166,367945,369119,368816,368227,369351,369285,371251,369943,371463,370262,370533,371057,370914,371062,370857,371587,372107,373300,373523,372958,372989,373280,371880,372771,372990,373249,374291,375616,374476,375765,374240,374347,375004,375368,374450,375710,377530,377157,377286,376285,376400,376609,376310,377381,377591,377095,377974,378737,378405,378587,379220,379423,378548,378699,378009,378960,381262,380164,379914,380197,381487,381776,380170,381552,381057,380154,382299,383652,382448,383355,383598,381941,383155,383681,383073,382389,385287,385672,384849,385151,384687,384533,384209,384112,384750,385264,386103,387747,387313,385807,387302,386443,386249,386467,386727,386612,388156,388416,388204,387865,389132,388788,389150,388950,389586,389036,391180,390872,390871,391308,389979,390494,391624,391769,390409,390676,392427,393142,392188,392136,391852,393129,392712,392223,392992,392945,394077,394071,395018,394093,395374,394972,394686,395107,394381,394538,397240,396966,396826,396854,396407,396978,397229,397081,396379,396428,397803,399566,397920,398867,399350,397907,398739,398986,399505,398263]
期望: 267
实际输出：268
```
数据比较多，也未仔细去检查哪个地方未处理

### 方法二
基本思路还是和方法一一样，只是不再保存每个块中的最小值了。为什么不需要保存了呢？  

拿示例2来讲，遍历到 1 的时候会发现 1 比 2 小，因此 2， 1 需要在一块，我们可以将 2 和 1 融合，
并重新压回栈。那么融合成 1 还是 2 呢？答案是 2，因为 2 是瓶颈，这提示我们可以用一个递增栈来完成。

因此本质上栈存储的每一个元素就代表一个块，而栈里面的每一个元素的值就是块的最大值。  

以 [2,1,3,4,4,1] 来说， stack 的变化过程大概是：

[2]

1 被融合了，保持 [2] 不变

[2,3]

[2,3,4]

[2,3,4,4]

[4]

简单来说，就是将一个减序列压缩合并成最该序列的最大的值。 因此最终返回 stack 的长度就可以了。

具体算法参考代码区

#### 代码
````Go
func maxChunksToSorted(arr []int) int {
	var cache []int
	for _, item := range arr {
		lastIdx := len(cache) - 1
		if len(cache) != 0 && cache[lastIdx] > item {
			max := cache[lastIdx]
			for ; lastIdx >= 0; lastIdx-- {
				if cache[lastIdx] <= item {
					break
				}
			}
			cache = append(cache[:lastIdx + 1], []int{max}...)
		} else {
			cache = append(cache, item)
		}
	}
	return len(cache)
}
````

## 相关题目
